<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ñ–∏–≤—ã–µ –∑–∞–∫–∞–∑—ã SUPFLOT</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables + Buttons + ColVis -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <style>
    /* –î–ª—è —Ç–æ—Å—Ç–∞ */
    #liveToast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1060;
    }
  </style>
</head>
<body>
  <div class="container mt-4">

    <!-- –¢–æ—Å—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="toast align-items-center text-bg-info border-0" id="liveToast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">
          –ù–æ–≤–∞—è –±—Ä–æ–Ω—å!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
    </div>

    <h2>–ñ–∏–≤—ã–µ –∑–∞–∫–∞–∑—ã</h2>
    <table id="bookings" class="table table-striped table-bordered w-100">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>–ò–º—è</th>
          <th>–õ–æ–≥–∏–Ω</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
          <th>–î–æ—Å–∫–∞</th>
          <th>–î–∞—Ç–∞</th>
          <th>–í—Ä–µ–º—è</th>
          <th>–ß–∞—Å—ã</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–°—É–º–º–∞, ‚ÇΩ</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- JS: Bootstrap, jQuery, DataTables, Buttons, ColVis, Socket.IO -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
  $(function(){
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap Toast
    const toastEl = document.getElementById('liveToast');
    const toast    = new bootstrap.Toast(toastEl);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTable —Å AJAX
    const table = $('#bookings').DataTable({
      ajax: {
        url: '/api/bookings',
        dataSrc: ''             // –±–µ—Ä—ë–º –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é
      },
      columns: [
        { data: 'id' },
        { data: 'full_name' },
        { data: 'username',
          render: d => d ? `<a href="https://t.me/${d}" target="_blank">${d}</a>` : '' },
        { data: 'phone',
          render: d => d ? `<a href="tel:${d}">${d}</a>` : '' },
        { data: 'partner' },
        { data: 'board' },
        { data: 'date' },
        { data: 'start_time',
          render: v => ("0"+v).slice(-2)+":00" },
        { data: 'duration', render: v => v + " —á" },
        { data: 'quantity' },
        { data: 'amount',
          render: v => parseFloat(v).toFixed(2) + " ‚ÇΩ" },
        { data: 'status',
          render: s => ({
            'active':       '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞',
            'waiting_card': '‚è≥ –û–∂–∏–¥–∞–µ—Ç (–∫–∞—Ä—Ç–∞)',
            'waiting_cash': '‚è≥ –û–∂–∏–¥–∞–µ—Ç (–Ω–∞–ª.)',
            'completed':    'üü¢ –ó–∞–≤–µ—Ä—à–µ–Ω–∞',
            'canceled':     '‚ùå –û—Ç–º–µ–Ω–µ–Ω–∞'
          }[s] || s)
        }
      ],
      dom: 'Bfrtip',
      buttons: [
        { extend:'copy', text:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å' },
        { extend:'csv',  text:'CSV' },
        { extend:'excel',text:'Excel' },
        { extend:'print',text:'–ü–µ—á–∞—Ç—å' },
        { extend:'colvis',text:'–°—Ç–æ–ª–±—Ü—ã' }
      ],
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/ru.json' },
      pageLength: 25,
      order: [[6,'desc'],[7,'desc']]
    });

    // WebSocket: –ø—Ä–∏ –Ω–æ–≤–æ–π –±—Ä–æ–Ω–µ –ø–æ–∫–∞–∂–µ–º —Ç–æ—Å—Ç –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Ç–∞–±–ª–∏—Ü—É
    const socket = io();
    socket.on('new_booking', data => {
      $('#toastBody').text(`–ù–æ–≤–∞—è –±—Ä–æ–Ω—å ID=${data.id}`);
      toast.show();
      table.ajax.reload(null, false);
    });
  });
  </script>
</body>
</html>
